from django.shortcuts import render
from django.http import HttpResponse, JsonResponse
import requests
import base64

def upload_image(request):
    if request.method == 'POST' and request.FILES.get('image'):
        image = request.FILES['image']
        
        try:
            image_base64 = base64.b64encode(image.read()).decode('utf-8')
            
            api_url = 'http://api:8001/detection/detect'
            payload = {
                'image_base64': image_base64,
                'user_id': request.user.id if request.user.is_authenticated else None
            }
            
            response = requests.post(api_url, json=payload, timeout=30)
            result = response.json()
            
            if result.get('success'):
                request.session['detection_results'] = result
                return render(request, 'traffic_signs/results.html', {
                    'results': result.get('results', []),
                    'processing_time': result.get('processing_time', 0),
                    'success': result.get('success', False)
                })
            else:
                return render(request, 'traffic_signs/upload.html', {
                    'error': result.get('error', 'Unknown error')
                })
                
        except Exception as e:
            return render(request, 'traffic_signs/upload.html', {
                'error': str(e)
            })
    
    return render(request, 'traffic_signs/upload.html')

def api_upload(request):
    if request.method == 'POST' and request.FILES.get('image'):
        image = request.FILES['image']
        
        try:
            image_base64 = base64.b64encode(image.read()).decode('utf-8')
            
            api_url = 'http://api:8001/detection/detect'
            payload = {
                'image_base64': image_base64,
                'user_id': request.user.id if request.user.is_authenticated else None
            }
            
            response = requests.post(api_url, json=payload, timeout=30)
            return JsonResponse(response.json())
            
        except Exception as e:
            return JsonResponse({
                'success': False,
                'error': str(e)
            }, status=500)
    
    return JsonResponse({'error': 'No image provided'}, status=400)

def api_documentation(request):
    return render(request, 'traffic_signs/api_docs.html')

def detection_results(request):
    results = request.session.get('detection_results', {})
    
    if not results:
        return render(request, 'traffic_signs/upload.html')
    
    return render(request, 'traffic_signs/results.html', {
        'results': results.get('results', []),
        'processing_time': results.get('processing_time', 0),
        'success': results.get('success', False)
    })
